FROM node:23-alpine AS node


# install dependencies
FROM node AS install-dependencies

# ğŸš¨ ë¡œì»¬ì—ì„œ ë¹Œë“œí•˜ë©´ ë¹Œë“œê°€ ë˜ì§€ ì•ŠìŒ
# ìƒìœ„ ë””ë ‰í† ë¦¬ì— ìˆëŠ” @nettiwork/commonì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ tmpë¡œ ë³µì‚¬
# deploy-api-server.ymlì˜ `Copy @nettiwork to tmp` ì°¸ê³ 
WORKDIR /
COPY ./tmp ./

WORKDIR /app
COPY package.json ./
COPY yarn.lock ./

RUN yarn install --frozen-lockfile --production



# build typescript
FROM install-dependencies AS build-typescript

COPY tsconfig.json ./
COPY src/ ./src

RUN yarn install --frozen-lockfile && yarn tsc



# final
FROM node AS final

RUN mkdir -p /home/node/app/dist
USER node

# set CWD
WORKDIR /home/node/app

COPY --chown=node:node package.json ./
COPY --chown=node:node yarn.lock ./
COPY --chown=node:node --from=install-dependencies \
  /app/node_modules \
  ./node_modules

RUN yarn check --verify-tree --production
COPY --chown=node:node --from=build-typescript \
  /app/dist \
  ./dist

# disable process limit
RUN ulimit -n 65536



EXPOSE 3000
ENTRYPOINT ["node", "./dist/server.js"]
